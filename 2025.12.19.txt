1) CentOS 7 이후 pam_pwquality  모듈 사용
2) credit
 ucredit: Uppercase Letter Credit (대문자 크레딧)
 lcredit: Lowercase Letter Credit (소문자 크레딧)
 dcredit: Digit Credit (숫자 크레딧)
 ocredit: Other Character Credit (기타 특수문자 크레딧)
3) credit 값 의미 
-1 해당 유형의 문자가 반드시 최소 1개 이상 있어야 함 (필수)
 0 해당 유형의 문자가 있으면 점수 1점, 없어도 됨 (필수 아님)
 1 이상 해당 문자가 있으면 그만큼의 추가 크레딧을 더해줌 (있으면 좋음, 없어도 됨)
4) 예시
minlen=8 (최소 총 크레딧이 8이어야 통과)
dcredit=-1 ➝ 숫자가 반드시 1개 이상 있어야 함  (-N 은  N개가 있어야 함)
ucredit=2 ➝ 대문자 2개 있으면 1점씩 크레딧 제공됨


/usr/lib64/security/pam_securetty.so

root@roror:/etc/pam.d# find /etc -type f -name "*" -exec grep -H "roror" {} \;


- console  관리자(root) 접근 제어
1) /usr/lib64/security/pam_securetty.so
2) /etc/securetty  (리스트 내용이 있으면 root 접근허용)
3) # vi /etc/pam.d/login
 - SSH : PermitRootLogin no (암기)

- pam_listfile.so (ssh, su)
1) 접근제어 설정하고 점검하시오? (기능은 정상인가?)


auth       required pam_listfile.so item=user sense=deny file=/etc/su.conf onerr=succeed
auth       required pam_listfile.so item=user sense=allow file=/etc/ssh/sshusers onerr=succeed
    - item=user은 기본적으로 “타겟 사용자“를 의미하게 된다. (tty, rhost, ruser, group, shell 등)
    - onerr=succeed  // 리스트 파일 오류 시에도 인증 통과 (허용)
    - onerr=fail   // 리스트 파일을 읽는 데 문제가 생기면 인증 실패 (차단)
    - sense=allow : 허용할 사용자
    - sense=deny : 거부할 사용자


PAM (Pluggable Authentication Modules) 기반 Access 로그인 접근 제어
tcp_wrapper : /etc/hosts.allow, /etc/hosts.deny

access 란
 - 누가(사용자), 어디서(호스트/TTY) 로그인 가능한지를 설정
 - 더 정교한 조건 지정 가능(보안 정책 유연성 높음)
password-auth
system-auth
login
account    required   pam_access.so

# vi /etc/security/access.conf
    <허용/차단>:<사용자>:<접속 출처>   
    +는 허용, -는 차단
   (사용자)사용자 이름 또는 그룹 (그룹은 @groupname) 형식
   (접속 출처) 호스트/IP 주소, TTY 이름 등
-:root:ALL
-:user:ALL
-:user:10.0.0.100 
-:user:ALL EXCEPT LOCAL 10.0.0.130  (user로 로그인 시도 시 LOCAL, 10.0.0.130  만 허용)
-:ALL EXCEPT @wheel:ALL
-:ALL:ALL EXCEPT tty1 tty2
- 여러 규칙이 존재시 위에서 아래로 차례로 적용된다.



리스트에 있는 사용자만 적용됨 새로운 사용자는 적용 안됨.. 확인해봐랴되나




- 문제 1 : 관리자(root)는 로컬, 원격에서 접속 불가(ssh 로 접속후 su 이용하여 관리자 접근 금지)
         2 : su 는  wheel group 만 사용가능
         3 : rororlocal  사용자만 아래의 명령어 사용 가능(해당 사용자는 로컬에서만 사용 가능)
                      1) 관리자 권한으로 실행
                       /usr/bin/journalctl, /usr/bin/systemctl status, /usr/sbin/ss, /bin/ps

                       2) 관리자 권한으로 실행 불가(지정)
                       /lib/systemd/systemd, /usr/lib/systemd/systemd, \
                       /sbin/init, /bin/init, /usr/bin/systemctl, \
                       /usr/sbin/reboot, /usr/sbin/shutdown, \
                       /bin/cat, /usr/bin/less, /usr/bin/vi, /usr/bin/nano, \
                       /usr/bin/find, /usr/bin/wget, /usr/bin/curl, \
                       /usr/bin/python*, /usr/bin/bash  






- Brute force 보호
# dnf --enablerepo=epel install fail2ban
root@roror:/etc/security# vi /etc/fail2ban/jail.conf

[sshd]    (시간설정 : 1w, 1d, 1h, 1m, 60)
enabled  = true   
port    = 22022
bantime = 3m (접근실패횟수가 넘어간 IP에 대해 정해진 시간만큼 접근을 원천차단한다)
findtime = 5m (실패횟수를 체크할 시간범위)
maxretry = 3 (IP블럭의 기준이 되는 실패횟수)

280 enabled = yes
281 bantime = 3m
282 findtime = 5m
283 maxretry = 3
284 port    = ssh


root@roror:/etc/security# systemctl start fail2ban

root@roror:/etc/security# fail2ban-client status sshd

root@roror:/etc/security# fail2ban-client set sshd unbanip 10.0.0.2

root@roror:/etc/security# fail2ban-client unban --all



root@roror:/etc/pam.d# find /usr -type f -name "pam_faillock.so" 2>/dev/null
/usr/lib64/security/pam_faillock.so

root@roror:/etc/pam.d# vi /etc/pam.d/password-auth
 7 auth        required                                     pam_faillock.so preauth silent audit deny=3 unlock_time=600



# fail2ban-client status sshd
# fail2ban-client set sshd unbanip 10.0.0.2
# fail2ban-client unban --all

pam_faillock (pam_tailly)
/usr/lib64/security/pam_faillock.so
auth        required       pam_faillock.so preauth silent audit deny=3 unlock_time=600
auth        [default=die] pam_faillock.so authfail audit
auth        required      pam_faillock.so reset
account     required      pam_faillock.so 
 auth required pam_env.so 환경 변수를 설정하는 기본 모듈이다.
 auth required pam_faillock.so preauth silent audit deny=3 unlock_time=600 : 인증 시도 전에 실패 기록을 체크하며, 3회 실패 시 600초(10분) 동안 계정을 잠근다.
 auth sufficient pam_unix.so nullok try_first_pass : 시스템 로컬 사용자 인증을 수행하며, 패스워드가 없거나 첫 번째 패스워드 시도를 성공하면 인증을 완료한다.
 auth [default=die] pam_faillock.so authfail audit : 인증 실패 후 pam_faillock을 호출해 실패 횟수를 기록하며, 실패하면 인증을 중단한다.
 auth required pam_faillock.so reset : 인증이 성공할 경우 실패 횟수를 초기화한다.
 account required pam_faillock.so : 계정의 현재 잠금 상태를 관리한다.


root@roror:/etc/pam.d# faillock   // 차단된 ip 보여줌..?
roror:
When                Type  Source                                           Valid
2025-12-19 14:36:57 RHOST 10.0.0.2                                             V
2025-12-19 14:37:01 RHOST 10.0.0.2                                             V
2025-12-19 14:37:05 RHOST 10.0.0.2                                             V
root@roror:/etc/pam.d# faillock --user roror --reset
root@roror:/etc/pam.d# faillock
roror:
When                Type  Source                                           Valid



# faillock 
# faillock --user roror --reset
ROOT 도 적용시 처음 설정값을 아래처럼 even_deny_root 추가
   auth        required      pam_faillock.so preauth silent audit deny=3 even_deny_root unlock_time=600

pam_tailly ---> pam_tailly2 ---> pam_faillok ---> 명령어

1) 리스트 확인
# authselect list 
# authselect list-features --help
# authselect list-features sssd

2) 현재 정책 확인
# authselect current
    - minimal – 로컬 사용자 인증만 사용하는 최소 구성(/etc/passwd 만 인증 허용)
    - sssd – SSSD를 통한 중앙 인증(LDAP/AD 등) + 로컬 사용자 인증
    - winbind – Windows 도메인(AD)과 연동된 인증 방식

3) 정책 복사(생성)
# authselect create-profile -b sssd security-profile
/etc/authselect/custom/security-profile  (복사본 생성)

4) 정책 적용
# authselect select custom/security-profile with-fingerprint with-silent-lastlog
# authselect list
# authselect select local --force  (강제로 변경)
# authselect enable-feature with-fingerprint
# authselect enable-feature with-silent-lastlog
# authselect disable-feature with-silent-lastlog
with-fingerprint : 지문 인식 장치를 통한 사용자 인증을 활성화하는 기능이다.
with-silent-lastlog : 로그인할 때 “마지막 로그인 시간” 정보를 사용자에게 표시하지 않고 조용히 넘어가게 하는 기능이다.


root@roror:/etc/authselect/custom# authselect create-profile -b sssd security-profile
authselect list-features local 
authselect list-features  custom/security-profile 
authselect current
authselect select custom/security-profile with-fingerprint with-silent-lastlog

authselect select local --force

authselect enable-feature with-fingerprint
authselect enable-feature with-silent-lastlog

root@roror:/etc/authselect/custom/security-profile# vi /etc/security/faillock.conf 
  6 dir = /var/run/faillock
 10 audit
 14 silent
 32 deny = 3
 45 unlock_time = 600
root@roror:/etc/authselect/custom/security-profile# authselect apply-changes 



# authselect list-features custom/security-profile | grep fail
# authselect enable-feature with-faillock
# cat password-auth | grep fail
# authselect current
# vi /etc/security/faillock.conf
# authselect apply-changes

  (1) 현재 선택된 authselect 프로파일의 설정을 다시 시스템에 적용한다.
  (2) /etc/pam.d/ 아래의 인증 설정 파일(system-auth, password-auth 등)을 새로 생성하거나 업데이트한다.
  (3) /etc/nsswitch.conf 파일을 프로파일에 맞게 재구성할 수 있다.
  (4) pam, nsswitch.conf, 기타 인증 관련 설정을 선택한 프로파일 기준으로 다시 덮어쓴다.
  (5) 프로파일 파일(/etc/authselect/custom/프로파일명/)을 수정했을 때 그 변경 내용을 반영하려면 반드시 실행해야 한다.
  (6) authselect 프로파일을 복제해서 수정했을 경우, 적용되지 않은 변경사항을 반영하는 명령이다.
  (7) authselect select 명령어를 새로 실행하지 않고도 수정 사항을 활성화할 수 있다.


------------------------------
1) LDAP 구축(Windows Server)
2) Windows 11, Linux 에서 동일한 ID/PW로 접속하고 허가된 사용자에게 특정 디렉토리를 공유한다.
3) realm
 - 리눅스 환경에서 realm은 SSSD(System Security Services Daemon)와 함께 도메인 가입 및 인증을 관리하는 명령줄 도구이다. 특히 Active Directory(AD), Kerberos, LDAP 기반의 네트워크 환경에 시스템을 통합할 때 사용된다. 즉 리눅스 시스템을 Kerberos 기반의 AD(Active Directory) 또는 IPA 서버에 간단히 가입(join) 시켜주는 유틸리티이다
4) Kerberos
- Kerberos는 비밀번호를 직접 보내지 않고, 암호화된 티켓을 이용해 안전하게 로그인과 서비스 접근을 가능하게 하는 인증 프로토콜
- Kerberos는 사용자가 인증서(티켓)를 미리 받아두고, 그걸 서버에 제출해서 인증받는 안전한 시스템이다.
- Kerberos 특징
 (1) 중앙 인증 서버 	Key Distribution Center (KDC)
 (2) 암호화 방식 	대칭키 기반
 (3) 티켓 기반		사용자 인증 후 서비스 접근 시마다 티켓 사용
 (4) 비밀번호 직접 전송 X	네트워크 상에 비밀번호가 노출되지 않음
 (5) 시간 동기화 필수	클라이언트와 서버 간 시간이 어긋나면 인증 실패
5) (참고) - 외부 접근시(공인IP)
 (1) AD 서버가 외부에서 접근 가능해야 함
  - 고정 공인 IP 또는 VPN을 통해 접근 가능해야 함
  - 방화벽에서 포트 개방 (예: 389, 636, 88, 445, 135, 139 등)
 (2) DNS 문제 해결
  - 클라이언트가 AD 도메인 이름(예: ad.domain.com)을 정상적으로 해석(DNS)할 수 있어야 함
  - 외부 DNS 또는 /etc/hosts, 내부 DNS 포워딩 설정 등 필요
 (3) Kerberos 및 시간 동기화 필수
  - 리눅스/윈도우 모두 NTP 동기화로 AD와 시각 차이 5분 이내 유지
 (4) 디렉터리 공유는 SMB 기반
  - Windows 서버에서 공유 디렉터리는 SMB/CIFS 프로토콜로 공유
  - 리눅스는 cifs-utils 설치 후 mount -t cifs로 접근 가능
 (5) 기본 포트
  - LDAP/LDAPS: 389 / 636, Kerberos: 88, DNS: 53, SMB: 445
6) 외부 접근 결론
 - Windows 11에서 다른 네트워크에서도 LDAP(AD) 계정으로 로그인하고 SMB 공유에 접근하려면, AD 서버가 외부에서 접근 가능해야 하며, 일반적으로 VPN이나 가상 네트워크(VPN 연결 또는 ZeroTier 사용)를 통해 안전하게 연결해야 한다.
7) 참고사항(참고만)
 - SSH - GSSAPIAuthentication yes
 - 접속 - ssh -K roror@linuxhost
 - sudo - %domain\ admins@lsof.co.kr ALL=(ALL) ALL
 - log - journalctl -u sssd -f, journalctl -xe | grep krb
 - pam_sss.so(password-auth)  SSSD를 통해 인증 처리 (SSSD 내부에서 LDAP, Kerberos 등 사용)
8) SSO (Single Sign-On)
 - 한 번 로그인하면, 추가 로그인 없이 여러 시스템이나 서비스에 자동으로 인증되는 방식이다.
 - Windows/리눅스 내부 : Kerberos(Kerberos는 SSO를 구현하는 핵심 기술 중 하나, SSO를 가능하게 만드는 인증 방식 (티켓 기반))
   (1) Kerberos로 TGT (티켓) 발급   (2) 이후 파일 서버, 메일 서버, 내부 웹사이트 등에 추가 로그인 없이 접속   (3) 이 전체 흐름이 SSO이며, 내부 동작은 Kerberos 기반
 - 웹 기반 SSO : SAML, OAuth, OpenID Connect




(참고)AD DS가 설치되면 "로컬 로그인"이 어떻게 되는가?
● 도메인 컨트롤러(AD DS 설치된 서버)는 로컬 사용자 계정을 더 이상 사용하지 않는다.
● AD DS가 설치되면 이 서버는 도메인 컨트롤러 역할을 하게 된다.
● 로컬 SAM 데이터베이스(Local user DB)는 더 이상 사용되지 않는다.
● 즉, "로컬 계정"이라는 개념이 사라지고, 모든 로그인은 도메인 기반으로만 이루어져야 한다.
● 일반 사용자 계정(roror 등)은 도메인에 가입된 일반 PC에 로그인하도록 설정하고, 도메인 컨트롤러(서버)에는 관리자만 로그인할 수 있도록 설정해둔다.








@echo off
net use Z: /delete /yes
net use Z: \\서버이름\공유이름 /persistent:yes
Z:는 연결할 드라이브 문자. 
서버이름은 공유 폴더가 위치한 서버의 이름이고, 공유이름은 공유 폴더의 공유 이름이다.
/persistent:yes는 사용자가 로그온할 때마다 이 연결이 지속되도록 하는 옵션이다.


dnf install -y realmd sssd oddjob oddjob-mkhomedir adcli samba-common-tools krb5-workstation




# realm discover lsof.co.kr    // 도메인 찾기
- 처음에 관리자 계정을 성공적으로 조인한다음 일반 계정도 권한을 부여
# realm join -U Administrator lsof.co.kr
# vi /etc/sssd/sssd.conf    // 기본 설정 저장
# getent passwd 'roror@lsof.co.kr'   // 도메인 사용자 로그인 확인
# realm leave lsof.co.kr -U Administrator   // 도메인 탈퇴

root@roror:/etc/authselect/custom/security-profile# id roror@lsof.co.kr
id: ‘roror@lsof.co.kr’: no such user
root@roror:/etc/authselect/custom/security-profile# realm join -U Administrator lsof.co.kr
Password for Administrator@LSOF.CO.KR: 
root@roror:/etc/authselect/custom/security-profile# id roror@lsof.co.kr
uid=376201000(roror@lsof.co.kr) gid=376200513(domain users@lsof.co.kr) groups=376200513(domain users@lsof.co.kr)
root@roror:/etc/authselect/custom/security-profile# id administrator@lsof.co.kr
uid=376200500(administrator@lsof.co.kr) gid=376200513(domain users@lsof.co.kr) groups=376200513(domain users@lsof.co.kr),376200519(enterprise admins@lsof.co.kr),376200512(domain admins@lsof.co.kr),376200572(denied rodc password replication group@lsof.co.kr),376200518(schema admins@lsof.co.kr),376200520(group policy creator owners@lsof.co.kr)


# authselect create-profile -b sssd security-profile
# authselect select custom/security-profile with-fingerprint with-silent-lastlog with-mkhomedir
# authselect apply-changes
# systemctl restart sssd
# systemctl enable --now oddjobd
 - Oddjob Daemon : 비특권(non-root) 사용자나 다른 서비스가 시스템 수준 작업(예: 디렉터리 생성)을 요청할 수 있도록 해주는 D-Bus 기반의 서비스이다. 주로 SSSD, realmd, pam_mkhomedir.so 등에서 함께 사용한다.


$ ssh administrator@lsof.co.kr@roror.co.kr
$ ssh roror@lsof.co.kr@roror.co.kr
$ realm list
$ getent passwd roror@lsof.co.kr
$ kinit roror@LSOF.CO.KR   // kerberos 티켓 유무 확인
$ klist  // 티켓 확인

Linux (realm/sssd 사용) : administrator@lsof.co.kr만 가능 ← UPN만 인식함
- realm join 이후 sssd는 Kerberos 기반으로 인증함
- Kerberos는 "realm"을 반드시 포함한 형태 (user@REALM) 를 사용함
- 그래서 리눅스에서는 무조건 UPN 형식으로 로그인해야 됨
- UPN = 이메일 같은 로그인 ID
- sAMAccountName = 윈도우용 짧은 ID

# dnf install cifs-utils
# dnf install samba-client
$ smbclient -L //10.0.0.111 -U roror
# mkdir /backup
$ su -c "mount -t cifs //10.0.0.111/backup /backup -o username=roror,domain=lsof.co.kr,sec=ntlmssp"
- NTLMSSP는 윈도우 기반 인증 방식인 NTLM 프로토콜을 수행하는 인증 메커니즘으로, 주로 Samba나 AD 연동 시 사용한다.
- NTLMSSP는 패스워드를 평문으로 보내지 않는 Windows 인증 방식이지만, Kerberos보다 보안성이 낮아 가능하면 NTLMv2 이상만 사용하고 Kerberos를 우선하는 것이 권장한다.
$ su -c "mount -a"
$ su -c "umount //10.0.0.111/backup"
둘 다 암호화 통신을 지원하므로, 내부망이라면 큰 차이 없이 사용할 수 있다

fstab 등록
예) //10.0.0.111/backup  /backup  cifs  username=hacker,password=비밀번호,domain=lsof.co.kr,sec=ntlmssp,iocharset=utf8,nofail  0  0
(1) /root/.smbcredentials 파일 만들기
# vi /root/.smbcredentials
username=hacker
password=비밀번호
domain=lsof.co.kr
(2) # chmod 600 /root/.smbcredentials
(3) /etc/fstab 수정
//10.0.0.111/backup  /backup  cifs  credentials=/root/.smbcredentials,sec=ntlmssp,iocharset=utf8,nofail  0  0


