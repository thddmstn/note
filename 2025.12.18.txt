


weekly
rotate 4
create
dateext
include /etc/logrotate.d
-------
/var/log/xferlog {
    # ftpd doesn't handle SIGHUP properly
    nocompress
    missingok
}

1) 매주 로그 파일을 로테이트 한다.
  - weekly
2) 최대 4번의 로테이트를 수행한다.
  - rotate 4
3) 각 로테이션을 마치고 빈 로그 파일을 생성한다.
  - create
4) 각 로그 파일의 마지막에 날짜를 붙인다.
  - dateext
5) 로그파일을 압축한다.
  - compress
6) 지정한 경로의 환경설정 파일도 읽어서 로테이트를 적용한다.
  - include /etc/logrotate.d
7) 특정 로그에 대해서만 설정 가능하다.
  - /var/log/wtmp
   monthly 
   create 0664 root utmp 
   minsize 1M
  rotate 1
 - 매달 로테이트를 최대 1회 실시하고 로그 파일은 0644 권한, root 사용자, utmp 그룹 속성을 갖는다. 용량이 1M가 넘어야지 로테이트 한다.
 - missingok (로그 파일이 없으면 에러를 출력하지 않고 다음 파일로 넘어간다.)
 - minsize 1M는 로그 파일을 회전(rotate)할지 여부를 결정하는 설정이다. 이 설정은 로그 파일의 크기가 최소 1MB에 도달할 때만 회전이 발생하도록 지정한다.
 - minsize 1M은 로그 파일이 1MB보다 작으면 회전하지 않고, 1MB 이상이 되어야 회전한다.(기간 상관 없다.)
 - size 10M: 로그 파일의 크기가 10MB 이상일 때 회전하도록 설정(M, K, G)



/usr/sbin/logrotate -v /etc/logrotate.conf

vi ~/log.sh
#!/bin/bash
cat /etc/user 2>&1 | logger -p local3.info
Testlog=`cat /etc/user 2>&1`
logger -p local3.info "Mylog : $Testlog"

vi /etc/rsyslog.conf
 68 local3.*                                                /var/log/myLog.log

sh log.sh
cat /var/log/messages
cat /var/log/myLog.log

`which logrotate` -v /etc/logrotate.conf


-------강사님 필기-----------------------------------------


# /usr/sbin/logrotate -v /etc/logrotate.conf

/etc/cron.*  에 logrotate 가 설정되어 반복적으로 작동 하였다.


# cat /usr/lib/systemd/system/logrotate.timer   의 [Timer] 부분 참고, 회전 시간 확인
# cat /usr/lib/systemd/system/logrotate.service  (logrotate를 systemd 서비스 유닛으로 실행하기 위한 정의이다.)

 1) 최근에는 systemd 타이머로 logrotate를 관리하는 방식으로 변경되었다.
 2) /etc/systemd/system/logrotate.timer 파일을 확인하고 활성화하여 logrotate가 주기적으로 실행되도록 설정할 수 있다.
 3) 최근에는 이전의 cron.daily/logrotate 대신, systemd 방식이 더 널리 사용된다.
 4) 파일 위치 : /etc/systemd/system/logrotate.timer, logrotate.service
  (참고)/etc/systemd/system/timers.target.wants
 5) 최신 시스템에서는 대부분 systemd를 통한 실행을 권장한다.


#!/bin/bash
r_ip=`who | awk -F[\(\)] '{print $2}'`
r_ip_bool=$?
public_ip=`wget https://ipecho.net/plain -O - -q`
userId=`id -un`
userId_bool=$?

if [ $r_ip_bool -eq 0 ] && [ $userId_bool -eq 0 ];then
for ip in $r_ip;do
        logger -p user.info "[Log] From=$ip, To=$public_ip, USER=$userId"
done
tail -5 /var/log/messages
else
	echo "오류가 발생하였습니다.!!!"
fi

 - tee : 표준 입력을 받아서 이를 표준 출력과 파일에 동시에 기록하는 역할을 한다.
export PROMPT_COMMAND='history -a >(tee -a ~/.bash_history | logger -t "$USER[$$]$SSH_CONNECTION")'
readonly PROMPT_COMMAND
PROMPT_COMMAND는 Bash 셸에서 프롬프트를 출력하기 전에 실행할 명령어를 지정하는 환경 변수이다. 
이 변수에 지정된 명령어는 프롬프트가 화면에 표시되기 직전에 실행된다.
ex) export PROMPT_COMMAND='echo "Hello, World!"'
readonly 읽기전용으로 설정
history -a  명령어 추가


ldd vsftpd
/etc/pam.d
/lib64
/lib64/security


root@roror:/lib64# vi /etc/pam.d/system-auth 
  9 #auth        sufficient                                   pam_unix.so nullok
 10 auth        sufficient                                   pam_unix.so try_first_pass debug

try_first_pass 이전 PAM 모듈에서 입력된 비밀번호가 있으면 그것을 재사용 없으면 새로 비밀번호를 요청

root@roror:/etc/pam.d# strace /lib64/security/pam_unix.so 
// 이게 뭐야


 1) agetty는 각 TTY (터미널 장치)에 로그인 프롬프트를 제공하는 프로그램이다. systemd에서 getty@tty1.service로 관리되며, 사용자가 로그인하면 PAM과 연결되어 인증 과정을 진행한다.
 2) strace는 시스템 콜을 추적할 수 있어서, agetty가 어떤 파일을 열고 읽는지, 특히 /etc/passwd나 /etc/shadow 같은 인증 파일 접근을 볼 수 있다.





1) auth   사용자 신원 확인 (인증)	(패스워드 입력, OTP, 인증 토큰, 공개키 인증 등)
2) account    계정의 상태 확인 	(계정 잠금, 사용 기한, 그룹 조건, 접근 허용 시간 등)
3) password  비밀번호 변경 처리용 	(passwd 명령 등에서 암호 변경 시에만 사용됨)
4) session  로그인 세션 준비 및 정리 	(환경 변수 설정, 자원 제한, 로그인 기록 등)


인터넷을 통해 검색하는 방법
	http://docs.redhat.com -> RHEL 문서 중 PAM 문서
	KLDP(Korean Linux Documentation Projection)
 	https://docs.rockylinux.org/guides/security/pa




auth required pam_env.so: 인증 요청 시 환경 변수를 설정합니다.
auth required pam_faildelay.so delay=2000000: 인증 실패 후 지연 시간을 2초로 설정합니다.
auth [default=1 ignore=ignore success=ok] pam_usertype.so isregular: 일반 사용자의 경우 특정 조건을 만족하면 인증 과정을 건너뜁니다.
auth [default=1 ignore=ignore success=ok] pam_localuser.so: 로컬 사용자인 경우 특정 조건을 만족하면 인증 과정을 건너뜁니다.
auth sufficient pam_unix.so nullok: UNIX 표준 인증을 사용하며, 비밀번호가 없는 경우에도 허용합니다.
auth [default=1 ignore=ignore success=ok] pam_usertype.so isregular: 위 3번과 유사한 설정입니다.
auth sufficient pam_sss.so forward_pass: SSS(Service Security Services) 인증을 사용하며, 인증 정보를 다음 모듈로 전달합니다.
auth required pam_deny.so: 위의 조건들을 모두 만족하지 않으면 인증을 거부합니다.
account required pam_unix.so: 계정 관리를 UNIX 표준 방식으로 처리합니다.
account sufficient pam_localuser.so: 로컬 사용자의 경우 추가 계정 관리 과정을 생략할 수 있습니다.
account sufficient pam_usertype.so issystem: 시스템 계정의 경우 추가 계정 관리 과정을 생략할 수 있습니다.
account [default=bad success=ok user_unknown=ignore] pam_sss.so: SSS를 사용하여 계정 관리를 수행합니다.
account required pam_permit.so: 위의 모든 조건을 만족하지 않더라도 계정 관리 과정을 허용합니다.
password requisite pam_pwquality.so local_users_only: 로컬 사용자의 비밀번호 품질을 확인합니다.
password sufficient pam_unix.so sha512 shadow nullok use_authtok: UNIX 표준으로 비밀번호를 관리하며, SHA512 알고리즘을 사용합니다.
password sufficient pam_sss.so use_authtok: SSS를 사용하여 비밀번호를 관리합니다.
password required pam_deny.so: 위의 모든 조건을 만족하지 않으면 비밀번호 변경을 거부합니다.
session optional pam_keyinit.so revoke: 세션 시작 시 키 초기화 모듈을 사용합니다.
session required pam_limits.so: 세션에 리소스 제한을 적용합니다.
-session optional pam_systemd.so: systemd와 관련된 세션 처리를 수행합니다.
session [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid: 특정 조건에서 세션 초기화를 건너뜁니다.
session required pam_unix.so: UNIX 표준 방식으로 세션을 관리합니다.
session optional pam_sss.so: SSS를 사용하여 추가 세션 관리를 수행합니다.

- system-auth
auth required pam_env.so: 인증 과정 중에 필요한 환경 변수를 설정합니다.
auth required pam_faildelay.so delay=2000000: 인증 실패 시 지연 시간을 2초(2000000 마이크로초)로 설정합니다.
auth sufficient pam_fprintd.so: 지문 인증을 충분한 수단으로 사용합니다. 이 모듈이 성공하면, 다음 인증 단계는 건너뜁니다.
auth [default=1 ignore=ignore success=ok] pam_usertype.so isregular: 일반 사용자에 대한 특정 조건을 충족시키면 다음 인증 단계를 건너뜁니다.
auth [default=1 ignore=ignore success=ok] pam_localuser.so: 로컬 사용자에 대한 특정 조건을 충족시키면 다음 인증 단계를 건너뜁니다.
auth sufficient pam_unix.so nullok: UNIX 표준 인증 방식을 사용합니다. nullok 옵션은 비밀번호가 없는 사용자도 허용합니다.
auth [default=1 ignore=ignore success=ok] pam_usertype.so isregular: 위 4번과 유사한 설정입니다.
auth sufficient pam_sss.so forward_pass: SSS(Service Security Services) 인증 방식을 사용합니다. forward_pass는 인증 정보를 다음 모듈로 전달합니다.
auth required pam_deny.so: 위의 인증 방식들이 실패하면 인증을 거부합니다.
account required pam_unix.so: 계정 관리를 UNIX 방식으로 수행합니다.
account sufficient pam_localuser.so: 로컬 사용자에 대해서는 추가 계정 관리 과정을 생략합니다.
account sufficient pam_usertype.so issystem: 시스템 계정에 대해서는 추가 계정 관리 과정을 생략합니다.
account [default=bad success=ok user_unknown=ignore] pam_sss.so: SSS를 사용한 계정 관리를 수행합니다.
account required pam_permit.so: 위의 조건을 만족하지 않더라도 계정 관리 과정을 허용합니다.
password requisite pam_pwquality.so local_users_only: 로컬 사용자에 대한 비밀번호 품질을 검사합니다.
password sufficient pam_unix.so sha512 shadow nullok use_authtok: UNIX 표준으로 비밀번호를 관리합니다. SHA512 암호화를 사용합니다.
password sufficient pam_sss.so use_authtok: SSS를 사용한 비밀번호 관리를 수행합니다.
password required pam_deny.so: 위의 조건들을 만족하지 않으면 비밀번호 변경을 거부합니다.
session optional pam_keyinit.so revoke: 세션 시작 시 키 초기화 모듈을 사용합니다.
session required pam_limits.so: 세션에 리소스 제한을 적용합니다.
-session optional pam_systemd.so: systemd와 관련된 세션 처리를 수행합니다.
session [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid: 특정 서비스에서는 세션 초기화를 건너뜁니다.
session required pam_unix.so: UNIX 표준 방식으로 세션을 관리합니다.
session optional pam_sss.so: SSS를 사용하여 추가 세션 관리를 수행합니다.


